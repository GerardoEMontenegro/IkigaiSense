{% extends 'layouts/post_layout.html' %}

{% block content %} 
    
<main>
    <div class="max-w-4xl mx-auto px-4 py-8 text-[#3F4F36]">
    <!-- T√≠tulo -->
    <h1 class="text-4xl font-bold mb-4">{{ object.title }}</h1>

    <!-- Fecha y autor -->
    <p class="text-sm text-gray-500 mb-6">
        Publicado el {{ object.created_at|date:"d M Y" }} por {{ object.author }}
    </p>

    <!-- Imagen principal -->
    {% if object.image %}
        <img 
            src="{{ object.image.url }}" 
            alt="{{ object.title }}" 
            class="w-full h-auto object-cover rounded-lg shadow-lg mb-8"
        >
    {% endif %}

    <!-- üîπ Im√°genes adicionales de PostImage -->
    {% if object.images.exists %}
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            {% for img in object.images.all %}
                {% if img.image %}
                    <img 
                        src="{{ img.image.url }}" 
                        alt="Imagen de {{ object.title }}" 
                        class="w-full h-64 object-cover rounded-lg shadow-md hover:scale-105 transition-transform duration-200"
                    >
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}

        <p class="text-2xl text-[#19221d] font-spectral font-extralight">
            {{ object.content|linebreaks }}
        </p>

        <p class="flex font-tangerine text-4xl text-[#19221d] justify-end mr-24 mt-0">
            <strong>{{ object.author }}</strong>
        </p>
    </div>
        <div class="rounded-lg p-6 mt-8 mx-28" >
                     <!-- Volver -->
        <a href="{% url 'home' %}" class=" inline-block mt-10 text-green-600 hover:underline text-sm font-medium">
        ‚Üê Volver al inicio
        
            {% if user.is_authenticated and user == object.author %}
                <div class="justify-end mt-6 flex flex-wrap gap-3">
                    <!-- Bot√≥n Editar -->
                    <a href="{% url 'post:post_update' slug=object.slug %}"
                      class="inline-flex items-center gap-2 bg-[#3F4F36] hover:bg-[#2f3c28] text-white font-semibold py-2 px-4 rounded-md transition duration-200">
                        ‚úèÔ∏è Editar
                    </a>

                    <!-- Bot√≥n Eliminar (con confirmaci√≥n) -->
                    <button 
                        type="button"
                        onclick="confirmDelete()"
                        class="inline-flex items-center gap-2 bg-[#3F4F36] hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md transition duration-200">
                        üóëÔ∏è Eliminar post
                    </button>

                    <!-- Formulario oculto para eliminar (POST seguro con CSRF) -->
                    <form id="delete-post-form" method="post" action="{% url 'post:post_delete' slug=object.slug %}">
                        {% csrf_token %}
                    </form>
                </div>
            {% endif %}
       </div>

    <!-- PUNTUACI√ìN -->
<section class="shadow-md rounded-lg p-6 mt-8 mx-28">
  <h3 class="text-2xl font-semibold text-gray-900 mb-4">‚≠ê Valoraci√≥n</h3>

  <p class="text-lg text-gray-700 mb-4" id="average-rating-display">
    {% if average_rating %}
      Promedio: <strong>{{ average_rating|floatformat:1 }}</strong> / 5
      <span class="text-sm text-gray-500">({{ ratings_count }} voto{{ ratings_count|pluralize }})</span>
    {% else %}
      Este post a√∫n no tiene puntuaciones.
    {% endif %}
  </p>

  {% if user.is_authenticated %}
        <form id="rating-form" class="flex flex-col gap-3" method="post" action="{% url 'post:post_rating' object.slug %}">
      {% csrf_token %}

      <div class="flex items-center gap-2">
        <label class="text-sm text-gray-800">Tu puntuaci√≥n:</label>
        <div class="flex items-center gap-1" id="star-rating">
          {% for i in stars %}
            <svg data-value="{{ i }}"
                 xmlns="http://www.w3.org/2000/svg"
                 fill="{% if user_rating|default_if_none:0 >= i %}#facc15{% else %}#e5e7eb{% endif %}"
                 viewBox="0 0 24 24"
                 class="w-6 h-6 cursor-pointer hover:scale-110 transition-transform duration-150">
              <path stroke="#d1d5db" stroke-width="1.5" d="M12 2l2.9 5.9L21 9.1l-4.5 4.4L17.8 21 12 17.8 6.2 21l1.3-7.5L3 9.1l6.1-1.2L12 2z"/>
            </svg>
          {% endfor %}
        </div>
      </div>

      <input type="hidden" name="score" id="rating-input" value="{{ user_rating|default:0 }}">

    </form>
  {% else %}
    <p class="text-gray-500 text-sm">Inicia sesi√≥n para calificar este post.</p>
  {% endif %}
</section>

   
  </article>

  <hr class="my-10 border-gray-200">

    <form method="post" class="shadow-md rounded-lg p-6 mt-8 mx-28">
        {% csrf_token %}
        <h3 class="text-lg font-spectral font-semibold">Deja tu comentario:</h3>

        <div class="flex flex-col mt-3">
            <textarea
                name="content"
                rows="3"
                placeholder="Escribe aqu√≠ tu comentario..."
                class="w-full border text-3xl text-slate-800 font-tangerine border-gray-300 rounded-md my-3 p-3 focus:outline-none focus:ring-2 focus:ring-[#2a4236] transition"
            >{{ comment_form.content.value|default:'' }}</textarea>
        </div>

        {% if comment_form.content.errors %}
            <p class="text-sm text-red-600 mt-1">{{ comment_form.content.errors.0 }}</p>
        {% endif %}

        <button type="submit"
                class="flex justify-end border-2 border-white rounded-full bg-[#F6F2E6] text-[#203329] text-base font-spectral py-3 px-6 hover:bg-[#203329] hover:text-amber-50 transition duration-300">
            Publicar
        </button>
    </form>

    <div class="mx-28 mt-12">
        <h3 class="text-2xl font-spectral font-semibold text-[#2a4236] mb-6">Comentarios ({{ comments.count }})</h3>

        {% for comment in comments %}
            <div class="bg-gray-50 p-5 rounded-lg mb-5 relative">
                <p class="font-tangerine text-xl text-[#19221d]"><strong>{{ comment.author }}</strong></p>
                <p class="text-gray-800 mt-1 whitespace-pre-wrap">{{ comment.content|linebreaks }}</p>
                <p class="text-xs text-gray-500 mt-2">{{ comment.created_at|timesince }} ago</p>

                {% if user == comment.author %}
                    <div class="mt-3 space-x-4">
                        <button
                            class="like-button text-sm text-gray-600 hover:text-green-600 items-center gap-1"
                            data-comment-id="{{ comment.id }}"
                            aria-pressed="{% if user in comment.likes.all %}true{% else %}false{% endif %}"
                            type="button"
                            >üëç
                            <span class="likes-count">{{ comment.likes.count }}</span>
                        </button>
                        <button 
                            type="button" 
                            class="text-blue-600 hover:underline text-sm edit-toggle"
                            data-id="{{ comment.id }}"
                            data-content="{{ comment.content|escape }}">
                            ‚úèÔ∏è Editar
                        </button>

                        <form method="post" 
                              action="{% url 'comments:comment_delete' pk=comment.id %}" 
                              style="display: inline;" 
                              onsubmit="return confirm('¬øEst√°s seguro de que deseas eliminar este comentario?')">
                            {% csrf_token %}
                            <button type="submit" class="text-red-600 hover:underline text-sm">
                                üóëÔ∏è Eliminar
                            </button>
                        </form>

                    </div>

                    <form method="post" 
                        action="{% url 'comments:comment_edit' pk=comment.id %}" 
                        class="edit-form mt-4 p-3 bg-white border rounded-lg shadow hidden">
                        {% csrf_token %}
                        
                        <textarea 
                            name="content" 
                            rows="3"
                            class="w-full border border-gray-300 rounded-md p-2 font-tangerine text-slate-800 focus:outline-none focus:ring-2 focus:ring-[#2a4236]"
                            placeholder="Edita tu comentario...">{{ comment.content }}</textarea>

                        {% if form.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ form.errors.content }}</p>
                        {% endif %}

                        <div class="mt-2">
                            <button type="submit" 
                                    class="bg-[#445e35] text-white text-sm px-4 py-1 rounded hover:bg-[#203329]">
                                Guardar
                            </button>
                            <button type="button" 
                                    class="ml-2 text-gray-600 text-sm hover:underline cancel-edit">
                                Cancelar
                            </button>
                        </div>
                    </form>
                {% endif %}
            </div>
        {% empty %}
            <p class="text-gray-600 text-sm">No hay comentarios a√∫n. ¬°S√© el primero en comentar!</p>
        {% endfor %}
    </div>

    {% if messages %}
        <div class="mt-6 mx-28">
            {% for message in messages %}
                <div class="p-3 text-sm rounded-lg 
                    {% if message.tags == 'error' %}
                        bg-red-100 text-red-800
                    {% else %}
                        bg-green-100 text-green-800
                    {% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Usamos event delegation en el contenedor de comentarios
        const comentariosContainer = document.querySelector('.mx-28.mt-12'); // o usa un ID si puedes

        comentariosContainer?.addEventListener('click', function (e) {
            // Bot√≥n "Editar"
            if (e.target.matches('.edit-toggle')) {
                e.preventDefault();
                const container = e.target.closest('.bg-gray-50'); // contenedor del comentario
                const form = container.querySelector('.edit-form');
                const deleteForm = container.querySelector('form[action*="delete"]');

                // Mostrar formulario, ocultar botones
                form.classList.remove('hidden');
                e.target.classList.add('hidden');
                deleteForm?.classList.add('hidden');
            }

            // Bot√≥n "Cancelar"
            if (e.target.matches('.cancel-edit')) {
                e.preventDefault();
                const form = e.target.closest('.edit-form');
                const container = form.closest('.bg-gray-50');
                const editToggle = container.querySelector('.edit-toggle');
                const deleteForm = container.querySelector('form[action*="delete"]');

                form.classList.add('hidden');
                editToggle.classList.remove('hidden');
                deleteForm?.classList.remove('hidden');
            }
        });
    });
    document.addEventListener('DOMContentLoaded', () => {
    const stars = document.querySelectorAll('#star-rating svg');
    const ratingInput = document.getElementById('rating-input');
    const ratingForm = document.getElementById('rating-form');

    stars.forEach(star => {
      star.addEventListener('click', () => {
        const ratingValue = parseInt(star.getAttribute('data-value'));
        ratingInput.value = ratingValue;

        // Actualiza colores de estrellas
        stars.forEach(s => {
          const val = parseInt(s.getAttribute('data-value'));
          s.setAttribute('fill', val <= ratingValue ? '#facc15' : '#e5e7eb');
        });

        // Env√≠a el formulario autom√°ticamente
        ratingForm.submit();
      });
    });
  });
  document.addEventListener('DOMContentLoaded', () => {
  const likeButtons = document.querySelectorAll('.like-button');

  likeButtons.forEach(button => {
    button.addEventListener('click', () => {
      const commentId = button.getAttribute('data-comment-id');

      fetch(`/comment/${commentId}/like/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Accept': 'application/json',
        },
        credentials: 'same-origin',
      })
      .then(res => res.json())
      .then(data => {
        if (data.liked) {
          button.classList.add('text-green-600');
          button.setAttribute('aria-pressed', 'true');
        } else {
          button.classList.remove('text-green-600');
          button.setAttribute('aria-pressed', 'false');
        }
        button.querySelector('.likes-count').textContent = data.likes_count;
      });
    });
  });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
    function confirmDelete() {
        const confirmed = confirm("¬øEst√°s seguro de que deseas eliminar este post? Esta acci√≥n no se puede deshacer.");
        if (confirmed) {
            document.getElementById('delete-post-form').submit();
        }
    }
</script>

{% endblock content %}

